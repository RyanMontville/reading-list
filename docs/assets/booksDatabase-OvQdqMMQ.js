function Q(t,e){const n=document.createElement(t);return n.textContent=e,n}function R(t){const e=document.createElement("span");return e.setAttribute("class","material-symbols-outlined"),e.textContent=t,e}function _(t,e,n,o){const a=document.createElement("a");{const r=R(o);a.appendChild(r)}return a.setAttribute("href",e),a.setAttribute("target","_blank"),a.textContent=t,a}function X(t){const e=t.reduce((n,o)=>{const a=document.createElement("option");return a.textContent=o.toString(),a.setAttribute("value",o.toString()),n.appendChild(a),n},document.createElement("select"));return e.options[e.length-1].selected=!0,e}function Z(t){const e=document.createElement("div");e.setAttribute("class","book");const n=document.createElement("img");n.setAttribute("src",t.cover),e.appendChild(n);const o=document.createElement("section"),a=document.createElement("h3");a.textContent=t.bookTitle,o.appendChild(a);const r=t.authors.reduce((c,g)=>{const f=document.createElement("a");f.addEventListener("click",()=>window.location.href=`/reading-list/?author=${g}`);let y=document.createTextNode(g);return f.appendChild(y),c.appendChild(f),c},document.createElement("h4"));o.appendChild(r);const i=document.createElement("p"),d=new Date(t.dateRead);i.textContent=`Date Read: ${d.toLocaleString("default",{month:"long"})} ${d.getFullYear()}`,o.appendChild(i);const s=t.tags.reduce((c,g)=>{const f=document.createElement("li"),y=document.createTextNode(g);return f.addEventListener("click",()=>window.location.href=`/reading-list/?tag=${g}`),f.appendChild(y),c.appendChild(f),c},document.createElement("ul"));o.appendChild(s);const l=_("View on StoryGraph",t.moreInfo,!0,"open_in_new");return o.appendChild(l),e.appendChild(o),e}const I=(t,e)=>e.some(n=>t instanceof n);let P,v;function T(){return P||(P=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function V(){return v||(v=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const S=new WeakMap,D=new WeakMap,p=new WeakMap;function O(t){const e=new Promise((n,o)=>{const a=()=>{t.removeEventListener("success",r),t.removeEventListener("error",i)},r=()=>{n(b(t.result)),a()},i=()=>{o(t.error),a()};t.addEventListener("success",r),t.addEventListener("error",i)});return p.set(e,t),e}function F(t){if(S.has(t))return;const e=new Promise((n,o)=>{const a=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",i),t.removeEventListener("abort",i)},r=()=>{n(),a()},i=()=>{o(t.error||new DOMException("AbortError","AbortError")),a()};t.addEventListener("complete",r),t.addEventListener("error",i),t.addEventListener("abort",i)});S.set(t,e)}let C={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return S.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return b(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function L(t){C=t(C)}function $(t){return V().includes(t)?function(...e){return t.apply(B(this),e),b(this.request)}:function(...e){return b(t.apply(B(this),e))}}function W(t){return typeof t=="function"?$(t):(t instanceof IDBTransaction&&F(t),I(t,T())?new Proxy(t,C):t)}function b(t){if(t instanceof IDBRequest)return O(t);if(D.has(t))return D.get(t);const e=W(t);return e!==t&&(D.set(t,e),p.set(e,t)),e}const B=t=>p.get(t);function q(t,e,{blocked:n,upgrade:o,blocking:a,terminated:r}={}){const i=indexedDB.open(t,e),d=b(i);return o&&i.addEventListener("upgradeneeded",s=>{o(b(i.result),s.oldVersion,s.newVersion,b(i.transaction),s)}),n&&i.addEventListener("blocked",s=>n(s.oldVersion,s.newVersion,s)),d.then(s=>{r&&s.addEventListener("close",()=>r()),a&&s.addEventListener("versionchange",l=>a(l.oldVersion,l.newVersion,l))}).catch(()=>{}),d}const z=["get","getKey","getAll","getAllKeys","count"],G=["put","add","delete","clear"],E=new Map;function x(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(E.get(e))return E.get(e);const n=e.replace(/FromIndex$/,""),o=e!==n,a=G.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(a||z.includes(n)))return;const r=async function(i,...d){const s=this.transaction(i,a?"readwrite":"readonly");let l=s.store;return o&&(l=l.index(d.shift())),(await Promise.all([l[n](...d),a&&s.done]))[0]};return E.set(e,r),r}L(t=>({...t,get:(e,n,o)=>x(e,n)||t.get(e,n,o),has:(e,n)=>!!x(e,n)||t.has(e,n)}));const H=["continue","continuePrimaryKey","advance"],A={},k=new WeakMap,N=new WeakMap,K={get(t,e){if(!H.includes(e))return t[e];let n=A[e];return n||(n=A[e]=function(...o){k.set(this,N.get(this)[e](...o))}),n}};async function*U(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,K);for(N.set(n,e),p.set(n,B(e));e;)yield n,e=await(k.get(n)||e.continue()),k.delete(n)}function M(t,e){return e===Symbol.asyncIterator&&I(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&I(t,[IDBIndex,IDBObjectStore])}L(t=>({...t,get(e,n,o){return M(e,n)?U:t.get(e,n,o)},has(e,n){return M(e,n)||t.has(e,n)}}));const Y="MyBookDB",h="books",m="challenges",u="metadata",j=2,w=18;class J{dbPromise=q(Y,j,{upgrade(e,n,o,a){if(n<1){if(!e.objectStoreNames.contains(h)){const r=e.createObjectStore(h,{keyPath:"id"});r.createIndex("title","bookTitle",{unique:!1}),r.createIndex("authors","authors",{unique:!1,multiEntry:!0}),r.createIndex("dateRead","dateRead",{unique:!1})}e.objectStoreNames.contains(u)||e.createObjectStore(u,{keyPath:"key"})}if(n<2&&!e.objectStoreNames.contains(m)){const r=e.createObjectStore(m,{keyPath:"id",autoIncrement:!0});r.createIndex("challengeName","challengeName",{unique:!1}),r.createIndex("startDate","startDate",{unique:!1}),r.createIndex("endDate","endDate",{unique:!1}),r.createIndex("goal","goal",{unique:!1})}}});async initializeData(){try{const e=await this.dbPromise,o=(await e.get(u,"data_version"))?.value||0;if(o>=w){console.log(`Data is already up-to-date (v${o}).`);return}console.log(`Fetching updated data (v${w})...`);const[a,r]=await Promise.all([fetch("https://raw.githubusercontent.com/RyanMontville/reading-list/refs/heads/main/data/books.json"),fetch("https://raw.githubusercontent.com/RyanMontville/reading-list/refs/heads/main/data/challenges.json")]);if(!a.ok||!r.ok)throw new Error("Failed to fetch initial data from GitHub.");const i=await a.json(),d=await r.json(),s=e.transaction([h,m,u],"readwrite"),l=new Date().toLocaleString();await s.objectStore(u).put({key:"data_version",value:w}),await s.objectStore(u).put({key:"last_updated",value:l});for(const c of i)typeof c.dateRead=="string"&&(c.dateRead=new Date(c.dateRead)),await s.objectStore(h).put(c);for(const c of d)await s.objectStore(m).put(c);await s.objectStore(u).put({key:"data_version",value:w}),await s.done,console.log(`Database initialized: ${i.length} books, ${d.length} challenges.`)}catch(e){throw console.error("Failed to initialize database data:",e),e}}async getAllBooks(){return(await this.dbPromise).getAll(h)}async getAllChallenges(){return(await this.dbPromise).getAll(m)}async getBookById(e){return(await this.dbPromise).get(h,e)}async getVersions(){const e=await this.dbPromise,[n,o]=await Promise.all([e.get(u,"data_version"),e.get(u,"last_updated")]);return{appDataVersion:w,storedDataVersion:n?.value||0,dbVersion:j,lastUpdated:o?.value||"Never"}}async resetDatabase(){try{const n=(await this.dbPromise).transaction([h,m,u],"readwrite");await Promise.all([n.objectStore(h).clear(),n.objectStore(m).clear(),n.objectStore(u).clear(),n.done]),console.log("Database stores cleared successfully."),await this.initializeData()}catch(e){throw console.error("Failed to reset database:",e),e}}}const ee=new J;export{Q as a,ee as b,Z as c,X as d};
