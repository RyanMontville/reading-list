function Q(t,e){const n=document.createElement(t);return n.textContent=e,n}function R(t){const e=document.createElement("span");return e.setAttribute("class","material-symbols-outlined"),e.textContent=t,e}function _(t,e,n,o){const r=document.createElement("a");{const a=R(o);r.appendChild(a)}return r.setAttribute("href",e),r.setAttribute("target","_blank"),r.textContent=t,r}function X(t){const e=t.reduce((n,o)=>{const r=document.createElement("option");return r.textContent=o.toString(),r.setAttribute("value",o.toString()),n.appendChild(r),n},document.createElement("select"));return e.options[e.length-1].selected=!0,e}function Z(t){const e=document.createElement("div");e.setAttribute("class","book");const n=document.createElement("img");n.setAttribute("src",t.cover),e.appendChild(n);const o=document.createElement("section"),r=document.createElement("h3");r.textContent=t.bookTitle,o.appendChild(r);const a=t.authors.reduce((c,g)=>{const h=document.createElement("a");h.addEventListener("click",()=>window.location.href=`/reading-list/?author=${g}`);let y=document.createTextNode(g);return h.appendChild(y),c.appendChild(h),c},document.createElement("h4"));o.appendChild(a);const i=document.createElement("p"),d=new Date(t.dateRead);i.textContent=`Date Read: ${d.toLocaleString("default",{month:"long"})} ${d.getFullYear()}`,o.appendChild(i);const s=t.tags.reduce((c,g)=>{const h=document.createElement("li"),y=document.createTextNode(g);return h.addEventListener("click",()=>window.location.href=`/reading-list/?tag=${g}`),h.appendChild(y),c.appendChild(h),c},document.createElement("ul"));o.appendChild(s);const u=_("View on StoryGraph",t.moreInfo,!0,"open_in_new");return o.appendChild(u),e.appendChild(o),e}const I=(t,e)=>e.some(n=>t instanceof n);let v,x;function T(){return v||(v=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function V(){return x||(x=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const C=new WeakMap,D=new WeakMap,p=new WeakMap;function O(t){const e=new Promise((n,o)=>{const r=()=>{t.removeEventListener("success",a),t.removeEventListener("error",i)},a=()=>{n(f(t.result)),r()},i=()=>{o(t.error),r()};t.addEventListener("success",a),t.addEventListener("error",i)});return p.set(e,t),e}function F(t){if(C.has(t))return;const e=new Promise((n,o)=>{const r=()=>{t.removeEventListener("complete",a),t.removeEventListener("error",i),t.removeEventListener("abort",i)},a=()=>{n(),r()},i=()=>{o(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",a),t.addEventListener("error",i),t.addEventListener("abort",i)});C.set(t,e)}let B={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return C.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function j(t){B=t(B)}function $(t){return V().includes(t)?function(...e){return t.apply(S(this),e),f(this.request)}:function(...e){return f(t.apply(S(this),e))}}function W(t){return typeof t=="function"?$(t):(t instanceof IDBTransaction&&F(t),I(t,T())?new Proxy(t,B):t)}function f(t){if(t instanceof IDBRequest)return O(t);if(D.has(t))return D.get(t);const e=W(t);return e!==t&&(D.set(t,e),p.set(e,t)),e}const S=t=>p.get(t);function q(t,e,{blocked:n,upgrade:o,blocking:r,terminated:a}={}){const i=indexedDB.open(t,e),d=f(i);return o&&i.addEventListener("upgradeneeded",s=>{o(f(i.result),s.oldVersion,s.newVersion,f(i.transaction),s)}),n&&i.addEventListener("blocked",s=>n(s.oldVersion,s.newVersion,s)),d.then(s=>{a&&s.addEventListener("close",()=>a()),r&&s.addEventListener("versionchange",u=>r(u.oldVersion,u.newVersion,u))}).catch(()=>{}),d}const G=["get","getKey","getAll","getAllKeys","count"],H=["put","add","delete","clear"],E=new Map;function A(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(E.get(e))return E.get(e);const n=e.replace(/FromIndex$/,""),o=e!==n,r=H.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(r||G.includes(n)))return;const a=async function(i,...d){const s=this.transaction(i,r?"readwrite":"readonly");let u=s.store;return o&&(u=u.index(d.shift())),(await Promise.all([u[n](...d),r&&s.done]))[0]};return E.set(e,a),a}j(t=>({...t,get:(e,n,o)=>A(e,n)||t.get(e,n,o),has:(e,n)=>!!A(e,n)||t.has(e,n)}));const K=["continue","continuePrimaryKey","advance"],P={},k=new WeakMap,N=new WeakMap,z={get(t,e){if(!K.includes(e))return t[e];let n=P[e];return n||(n=P[e]=function(...o){k.set(this,N.get(this)[e](...o))}),n}};async function*U(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,z);for(N.set(n,e),p.set(n,S(e));e;)yield n,e=await(k.get(n)||e.continue()),k.delete(n)}function M(t,e){return e===Symbol.asyncIterator&&I(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&I(t,[IDBIndex,IDBObjectStore])}j(t=>({...t,get(e,n,o){return M(e,n)?U:t.get(e,n,o)},has(e,n){return M(e,n)||t.has(e,n)}}));const Y="MyBookDB",m="books",b="challenges",l="metadata",L=2,w=17;class J{dbPromise=q(Y,L,{upgrade(e,n,o,r){if(n<1){if(!e.objectStoreNames.contains(m)){const a=e.createObjectStore(m,{keyPath:"id"});a.createIndex("title","bookTitle",{unique:!1}),a.createIndex("authors","authors",{unique:!1,multiEntry:!0}),a.createIndex("dateRead","dateRead",{unique:!1})}e.objectStoreNames.contains(l)||e.createObjectStore(l,{keyPath:"key"})}if(n<2&&!e.objectStoreNames.contains(b)){const a=e.createObjectStore(b,{keyPath:"id",autoIncrement:!0});a.createIndex("challengeName","challengeName",{unique:!1}),a.createIndex("startDate","startDate",{unique:!1}),a.createIndex("endDate","endDate",{unique:!1}),a.createIndex("goal","goal",{unique:!1})}}});async initializeData(){try{const e=await this.dbPromise,o=(await e.get(l,"data_version"))?.value||0;if(o>=w){console.log(`Data is already up-to-date (v${o}).`);return}console.log(`Fetching updated data (v${w})...`);const[r,a]=await Promise.all([fetch("https://raw.githubusercontent.com/RyanMontville/reading-list/refs/heads/main/data/books.json"),fetch("https://raw.githubusercontent.com/RyanMontville/reading-list/refs/heads/main/data/challenges.json")]);if(!r.ok||!a.ok)throw new Error("Failed to fetch initial data from GitHub.");const i=await r.json(),d=await a.json(),s=e.transaction([m,b,l],"readwrite"),u=new Date().toLocaleString();await s.objectStore(l).put({key:"data_version",value:w}),await s.objectStore(l).put({key:"last_updated",value:u});for(const c of i)typeof c.dateRead=="string"&&(c.dateRead=new Date(c.dateRead)),await s.objectStore(m).put(c);for(const c of d)await s.objectStore(b).put(c);await s.objectStore(l).put({key:"data_version",value:w}),await s.done,console.log(`Database initialized: ${i.length} books, ${d.length} challenges.`)}catch(e){throw console.error("Failed to initialize database data:",e),e}}async getAllBooks(){return(await this.dbPromise).getAll(m)}async getAllChallenges(){return(await this.dbPromise).getAll(b)}async getBookById(e){return(await this.dbPromise).get(m,e)}async getVersions(){const e=await this.dbPromise,[n,o]=await Promise.all([e.get(l,"data_version"),e.get(l,"last_updated")]);return{appDataVersion:w,storedDataVersion:n?.value||0,dbVersion:L,lastUpdated:o?.value||"Never"}}}const ee=new J;export{Q as a,ee as b,Z as c,X as d};
